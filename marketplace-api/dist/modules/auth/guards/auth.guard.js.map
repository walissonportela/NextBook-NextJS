{"version":3,"sources":["../../../../src/modules/auth/guards/auth.guard.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext, UnauthorizedException } from \"@nestjs/common\";\nimport { Reflector } from \"@nestjs/core\";\nimport { JwtService } from \"@nestjs/jwt\";\nimport { IS_PUBLIC_KEY } from \"../decorators/public.decorator\";\nimport { Request } from \"express\";\nimport { AppConfigService } from \"src/core/infra/config/config.service\";\n\n@Injectable()\nexport class AuthGuard implements CanActivate {\n  constructor(private jwtService: JwtService, private reflector: Reflector, private configService: AppConfigService) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (isPublic) {\n      return true;\n    }\n\n    const request = context.switchToHttp().getRequest<Request>();\n    const token = this.extractTokenFromHeader(request);\n    if (!token) {\n      throw new UnauthorizedException();\n    }\n    try {\n      const payload = await this.jwtService.verifyAsync(token, {\n        secret: this.configService.jwtSecret,\n      });\n      request['user'] = payload;\n    } catch {\n      throw new UnauthorizedException();\n    }\n    return true;\n  }\n\n  private extractTokenFromHeader(request: Request): string | undefined {\n    const [type, token] = request.headers.authorization?.split(' ') ?? [];\n    return type === 'Bearer' ? token : undefined;\n  }\n}\n"],"names":["AuthGuard","canActivate","context","isPublic","reflector","getAllAndOverride","IS_PUBLIC_KEY","getHandler","getClass","request","switchToHttp","getRequest","token","extractTokenFromHeader","UnauthorizedException","payload","jwtService","verifyAsync","secret","configService","jwtSecret","type","headers","authorization","split","undefined"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARoE;sBACvD;qBACC;iCACG;+BAEG;;;;;;;;;;AAG1B,IAAA,AAAMA,YAAN,MAAMA;IAGX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,WAAW,IAAI,CAACC,SAAS,CAACC,iBAAiB,CAAUC,8BAAa,EAAE;YACxEJ,QAAQK,UAAU;YAClBL,QAAQM,QAAQ;SACjB;QACD,IAAIL,UAAU;YACZ,OAAO;QACT;QAEA,MAAMM,UAAUP,QAAQQ,YAAY,GAAGC,UAAU;QACjD,MAAMC,QAAQ,IAAI,CAACC,sBAAsB,CAACJ;QAC1C,IAAI,CAACG,OAAO;YACV,MAAM,IAAIE,6BAAqB;QACjC;QACA,IAAI;YACF,MAAMC,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,WAAW,CAACL,OAAO;gBACvDM,QAAQ,IAAI,CAACC,aAAa,CAACC,SAAS;YACtC;YACAX,OAAO,CAAC,OAAO,GAAGM;QACpB,EAAE,OAAM;YACN,MAAM,IAAID,6BAAqB;QACjC;QACA,OAAO;IACT;IAEQD,uBAAuBJ,OAAgB,EAAsB;QACnE,MAAM,CAACY,MAAMT,MAAM,GAAGH,QAAQa,OAAO,CAACC,aAAa,EAAEC,MAAM,QAAQ,EAAE;QACrE,OAAOH,SAAS,WAAWT,QAAQa;IACrC;IA9BA,YAAY,AAAQT,UAAsB,EAAE,AAAQZ,SAAoB,EAAE,AAAQe,aAA+B,CAAE;aAA/FH,aAAAA;aAAgCZ,YAAAA;aAA8Be,gBAAAA;IAAkC;AA+BtH"}