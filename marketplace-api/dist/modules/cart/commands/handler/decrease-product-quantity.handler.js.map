{"version":3,"sources":["../../../../../src/modules/cart/commands/handler/decrease-product-quantity.handler.ts"],"sourcesContent":["import { CommandHandler, ICommandHandler } from \"@nestjs/cqrs\";\nimport { DecreaseProductQuantityImpl } from \"../impl/decrease-product-quantity.impl\";\nimport { PrismaService } from \"src/core/infra/database/prisma.service\";\nimport { NotFoundException, BadRequestException } from \"@nestjs/common\";\n\n@CommandHandler(DecreaseProductQuantityImpl)\nexport class DecreaseProductQuantityHandler implements ICommandHandler<DecreaseProductQuantityImpl> {\n    constructor(private readonly prismaService: PrismaService) {}\n\n    async execute(command: DecreaseProductQuantityImpl) {\n        const { productId, quantity, userId } = command.data;\n\n        const cart = await this.prismaService.cart.findUnique({\n            where: {\n                userId\n            }\n        });\n\n        if (!cart) {\n            throw new NotFoundException('Cart not found');\n        }\n\n        const productInCart = await this.prismaService.productInCart.findFirst({\n            where: {\n                productId,\n                cartId: cart.id\n            },\n            include: {\n                product: true\n            }\n        });\n\n        if (!productInCart) {\n            throw new NotFoundException('Product not found in cart');\n        }\n\n        const newQuantity = productInCart.quantity - quantity;\n\n        if (newQuantity <= 0) {\n            // Se a quantidade ficar zero ou negativa, remove o produto do carrinho\n            await this.prismaService.productInCart.delete({\n                where: {\n                    productId_cartId: {\n                        productId,\n                        cartId: cart.id\n                    }\n                }\n            });\n\n            return {\n                message: 'Product removed from cart (quantity reached zero)',\n                product: productInCart.product,\n                quantity: 0\n            };\n        }\n\n        // Atualiza a quantidade\n        const updatedProductInCart = await this.prismaService.productInCart.update({\n            where: {\n                productId_cartId: {\n                    productId,\n                    cartId: cart.id\n                }\n            },\n            data: {\n                quantity: newQuantity\n            },\n            include: {\n                product: true\n            }\n        });\n\n        return {\n            message: 'Product quantity decreased successfully',\n            product: updatedProductInCart.product,\n            quantity: updatedProductInCart.quantity\n        };\n    }\n}\n"],"names":["DecreaseProductQuantityHandler","execute","command","productId","quantity","userId","data","cart","prismaService","findUnique","where","NotFoundException","productInCart","findFirst","cartId","id","include","product","newQuantity","delete","productId_cartId","message","updatedProductInCart","update"],"mappings":";;;;+BAMaA;;;eAAAA;;;sBANmC;6CACJ;+BACd;wBACyB;;;;;;;;;;AAGhD,IAAA,AAAMA,iCAAN,MAAMA;IAGT,MAAMC,QAAQC,OAAoC,EAAE;QAChD,MAAM,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,MAAM,EAAE,GAAGH,QAAQI,IAAI;QAEpD,MAAMC,OAAO,MAAM,IAAI,CAACC,aAAa,CAACD,IAAI,CAACE,UAAU,CAAC;YAClDC,OAAO;gBACHL;YACJ;QACJ;QAEA,IAAI,CAACE,MAAM;YACP,MAAM,IAAII,yBAAiB,CAAC;QAChC;QAEA,MAAMC,gBAAgB,MAAM,IAAI,CAACJ,aAAa,CAACI,aAAa,CAACC,SAAS,CAAC;YACnEH,OAAO;gBACHP;gBACAW,QAAQP,KAAKQ,EAAE;YACnB;YACAC,SAAS;gBACLC,SAAS;YACb;QACJ;QAEA,IAAI,CAACL,eAAe;YAChB,MAAM,IAAID,yBAAiB,CAAC;QAChC;QAEA,MAAMO,cAAcN,cAAcR,QAAQ,GAAGA;QAE7C,IAAIc,eAAe,GAAG;YAClB,uEAAuE;YACvE,MAAM,IAAI,CAACV,aAAa,CAACI,aAAa,CAACO,MAAM,CAAC;gBAC1CT,OAAO;oBACHU,kBAAkB;wBACdjB;wBACAW,QAAQP,KAAKQ,EAAE;oBACnB;gBACJ;YACJ;YAEA,OAAO;gBACHM,SAAS;gBACTJ,SAASL,cAAcK,OAAO;gBAC9Bb,UAAU;YACd;QACJ;QAEA,wBAAwB;QACxB,MAAMkB,uBAAuB,MAAM,IAAI,CAACd,aAAa,CAACI,aAAa,CAACW,MAAM,CAAC;YACvEb,OAAO;gBACHU,kBAAkB;oBACdjB;oBACAW,QAAQP,KAAKQ,EAAE;gBACnB;YACJ;YACAT,MAAM;gBACFF,UAAUc;YACd;YACAF,SAAS;gBACLC,SAAS;YACb;QACJ;QAEA,OAAO;YACHI,SAAS;YACTJ,SAASK,qBAAqBL,OAAO;YACrCb,UAAUkB,qBAAqBlB,QAAQ;QAC3C;IACJ;IAtEA,YAAY,AAAiBI,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AAuEhE"}